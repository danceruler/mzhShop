@using Mzh.Public.Model.Model;
@{
    BusinessModel businessModel = ViewBag.Business as BusinessModel;
}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>layui</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <link rel="stylesheet" href="~/wwwroot/lib/layui-v2.5.5/css/layui.css" media="all">
    <link rel="stylesheet" href="~/wwwroot/css/public.css" media="all">
</head>
<body>
    <input style="display:none" id="businessid" value="@businessModel.businessid" />
    <div class="layuimini-container">
        <div class="layuimini-main">
            @*<div class="layui-form-item">
                    <label class="layui-form-label"></label>
                    <div class="layui-input-inline" style="top:15px">
                        <input type="radio" name="isuseoldattr" id="y_isuseoldattr" checked="checked" value="1">是
                        <input type="radio" name="isuseoldattr" checked="checked" value="0">否
                    </div>
                </div>*@
            @if (businessModel.businessid == 0)
            {
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">商户名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="name" id="name" placeholder="" value="" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">商户地址</label>
                        <div class="layui-input-inline">
                            <input type="text" name="address" id="address" placeholder="" value="" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">联系方式</label>
                        <div class="layui-input-inline">
                            <input type="text" name="telphone" id="telphone" placeholder="" value="" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">简介</label>
                        <div class="layui-input-inline">
                            <textarea name="description" id="description" lay-verify="required" placeholder="" class="layui-textarea"></textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">开始营业时间</label>
                            @*<div class="layui-input-inline">
                                    <input type="number" name="shopprice" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>*@
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="st_hour" id="st_hour" lay-verify="required" autocomplete="off" value="8" class="layui-input">
                            </div>
                            <label class="layui-form-label">时</label>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="st_minute" id="st_minute" lay-verify="required" autocomplete="off" value="0" class="layui-input">
                            </div>
                            <label class="layui-form-label">分</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">结束营业时间</label>
                            @*<div class="layui-input-inline">
                                    <input type="number" name="shopprice" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>*@
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="end_hour" id="end_hour" lay-verify="required" autocomplete="off" value="8" class="layui-input">
                            </div>
                            <label class="layui-form-label">时</label>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="end_minute" id="end_minute" lay-verify="required" autocomplete="off" value="0" class="layui-input">
                            </div>
                            <label class="layui-form-label">分</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品详情图</label>
                        <div class="layui-input-block">
                            <div id="cupload-promainimgs"></div>
                        </div>
                    </div>
                    <div class="layui-form-item" style="margin-top:20px">
                        <div class="layui-input-block">
                            <button class="layui-btn addproduct" lay-submit="" lay-filter="demo1">保存</button>
                        </div>
                    </div>
                </form>
            }
            else
            {
                <form class="layui-form" action="">
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">商户名称</label>
                            <div class="layui-input-inline">
                                <input type="text" name="name" id="name" placeholder="" value="@businessModel.name" class="layui-input">
                            </div>
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">商户地址</label>
                        <div class="layui-input-inline">
                            <input type="text" name="address" id="address" placeholder="" value="@businessModel.address" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">联系方式</label>
                        <div class="layui-input-inline">
                            <input type="text" name="telphone" id="telphone" placeholder="" value="@businessModel.telphone" class="layui-input">
                        </div>
                    </div>
                    <div class="layui-form-item" id="attribute-div">
                        <label class="layui-form-label">简介</label>
                        <div class="layui-input-inline">
                            <textarea name="description" id="description" lay-verify="required" placeholder="" class="layui-textarea">@businessModel.description</textarea>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">开始营业时间</label>
                            @*<div class="layui-input-inline">
                                    <input type="number" name="shopprice" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>*@
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="st_hour" id="st_hour" lay-verify="required" autocomplete="off" value="@(businessModel.businessStart/60)" class="layui-input">
                            </div>
                            <label class="layui-form-label">时</label>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="st_minute" id="st_minute" lay-verify="required" autocomplete="off" value="@(businessModel.businessStart%60)" class="layui-input">
                            </div>
                            <label class="layui-form-label">分</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <div class="layui-inline">
                            <label class="layui-form-label">结束营业时间</label>
                            @*<div class="layui-input-inline">
                                    <input type="number" name="shopprice" lay-verify="required" autocomplete="off" class="layui-input">
                                </div>*@
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="end_hour" id="end_hour" lay-verify="required" autocomplete="off" value="@(businessModel.businessEnd/60)" class="layui-input">
                            </div>
                            <label class="layui-form-label">时</label>
                        </div>
                        <div class="layui-inline">
                            <div class="layui-input-inline">
                                <input type="number" name="end_minute" id="end_minute" lay-verify="required" autocomplete="off" value="@(businessModel.businessEnd%60)" class="layui-input">
                            </div>
                            <label class="layui-form-label">分</label>
                        </div>
                    </div>
                    <div class="layui-form-item">
                        <label class="layui-form-label">商品详情图</label>
                        <div class="layui-input-block">
                            <div id="cupload-promainimgs"></div>
                        </div>
                    </div>
                </form>
            }
            <div class="layui-input-block">
                <button class="layui-btn save" lay-submit="" lay-filter="demo1">保存</button>
            </div>
        </div>
    </div>
    <script src="~/wwwroot/lib/jquery-3.4.1/jquery-3.4.1.min.js" charset="utf-8"></script>
    <script src="~/wwwroot/lib/layui-v2.5.5/layui.js" charset="utf-8"></script>
    <script src="~/wwwroot/js/lay-config.js"></script>
    <script src="~/Scripts/mzhconfig.js"></script>
    <script src="~/wwwroot/js/cupload.js"></script>
    <!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
    <script>
        var businessid = $("#businessid").val()

        var promainimgs = [];
        @if (businessModel.businessid != 0)
        {
            foreach(var img in businessModel.imgs)
            {
                @:promainimgs.push("@img.bi_img");
            }
        }
        var cuploadpromainimgs = new Cupload({
            ele: '#cupload-promainimgs',
            num: 10,
            data: promainimgs.length == 0 ? null : promainimgs
        });

        layui.use(['form', 'layer'], function () {
            var $ = layui.jquery,
                form = layui.form,
                layer = layui.layer;

            
            form.render();
        });

        $(".save").click(function () {
                console.log('save')
                if ($("#name").val() == '') {
                    var index = layer.alert("商户名称不能为空", {
                        title: "请你注意"
                    }, function () {
                        // 关闭弹出层
                        layer.close(index);
                    });
                    return false;
                }
                if ($("#address").val() == '') {
                    var index = layer.alert("商户地址不能为空", {
                        title: "请你注意"
                    }, function () {
                        // 关闭弹出层
                        layer.close(index);
                    });
                    return false;
                }
                if ($("#description").val() == '') {
                    var index = layer.alert("简介不能为空", {
                        title: "请你注意"
                    }, function () {
                        // 关闭弹出层
                        layer.close(index);
                    });
                    return false;
                }
                if ($("#telphone").val() == '') {
                    var index = layer.alert("联系方式不能为空", {
                        title: "请你注意"
                    }, function () {
                        // 关闭弹出层
                        layer.close(index);
                    });
                    return false;
                }
                if ($("#st_hour").val() == ''||$("#st_minute").val() == ''||$("#end_hour").val() == ''||$("#end_minute").val() == '') {
                    var index = layer.alert("运营开始时间和结束时间必须输入", {
                        title: "请你注意"
                    }, function () {
                        // 关闭弹出层
                        layer.close(index);
                    });
                    return false;
                }

                var mainimgs = [];

                showloading(true);

                for (var i = 0; i < cuploadpromainimgs.imageList.children.length; i++) {
                    if ($(cuploadpromainimgs.imageList.children[i]).children('.cupload-image-preview')[0].src.indexOf("boiled") != -1) {
                        var newimg =
                        {
                            "bi_businessimgid": 0,
                            "bi_businessid": businessid,
                            "bi_img": $(cuploadpromainimgs.imageList.children[i]).children('.cupload-image-preview')[0].src
                        }
                        mainimgs.push(newimg);
                    } else {
                        $.ajax({
                            type: 'post',
                            url: domain + '/Upload/Base64Str',
                            data: { base64str: $(cuploadpromainimgs.imageList.children[i]).children('.cupload-image-preview')[0].src },
                            async: false,
                            success: function (res) {
                                if (res.state == 1) {
                                    var newimg = {
                                        "bi_businessimgid": 0,
                                        "bi_businessid": businessid,
                                        "bi_img": res.msg
                                    }
                                    mainimgs.push(newimg);
                                } else {
                                    showloading(false);
                                    layer.alert("商品详情图第" + (i + 1) + "张上传失败！");
                                    return false;
                                }
                            }
                        })
                    }
                }

                showloading(false);

            var businessStart = $("#st_hour").val() + ':' + $("#st_minute") + '-' + $("#end_hour").val() + ':' + $("#end_minute");
                var requestdata = {
                          "businessid": businessid,
                          "name": $("#name").val(),
                          "address": $("#address").val(),
                          "addtime": "2020-12-13T19:50:13.0571336+08:00",
                          "description": $("#description").val(),
                          "showimg": "",
                          "latitude": 1.0,
                          "longitude": 1.0,
                          "canSendRadius": 1.0,
                          "businessTimeStr": businessStart,
                          "businessStart": parseInt($("#st_hour").val())*60+parseInt($("#st_minute").val()),
                          "businessEnd": parseInt($("#end_hour").val())*60+parseInt($("#end_minute").val()),
                          "telphone": $("#telphone").val(),
                          "imgs": mainimgs
                        }

                $.ajax({
                        url: domain + '/Business/AddOrUpdateBusiness',
                        type: 'post',
                        data: requestdata,
                        async: false,
                        success: function (res) {
                            var index = layer.alert(res.msg, {
                                title: "提示"
                            }, function () {
                                // 关闭弹出层
                                layer.close(index);
                            });
                            if (res.state == 1) {

                            }
                        }
                    });



                return false;

            })


    </script>

</body>
</html>